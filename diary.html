<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Diary</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Nanum+Gothic:400,700,800&amp;subset=korean" rel="stylesheet"><!-- webfont -->
    <link rel="stylesheet" href="diary.css"><!-- 외부 스타일 불러오는 방법 -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
</head>
<body>
    <div id="diary_content_wrap" class="container"><!-- diary input wrap-->
        <h2 class="main_title text-center">내 건강 일기</h2>
        <div id="diary_input">
            <form class="form" action="#">
                <div class="food_diary">
                    <label name="">식단</label>
                    <input type="text" id="" name="" value="">   
                </div>
                <div class="health_diary">
                    <label name="">운동</label>
                    <input type="text" id="" name="" value="">   
                </div>  
                <div class="write_diary_wrap">
                    <div class="form-check-wrap">
                        <div class="form-check">
                            <input type="radio" class="check-btn" id="good" value="잘했음"><i class="far fa-grin"></i>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="check-btn" id="normal" value="보통"><i class="far fa-flushed"></i>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="check-btn" id="bad" value="힘들었음"><i class="far fa-angry"></i>
                        </div>
                        <button id="SaveButton" class="write_diary_save">저장</button>
                    </div>
                    
                    <div class="write_diary">
                        <textarea name="content" cols="100" rows="8" id="writeDiary"></textarea>
                    </div>  
                    <div id="showDiary">

                    </div> 
                </div>           
            </form>
        </div>
    </div><!-- //diary input wrap-->

    <div id="diary_history_wrap">  <!-- diary_history_wrap -->      
        <div class="container">
          <div class="row">


          </div>
          <div id="section">           
            <!-- Modal 
            <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body modal-diary-body">
                            바디내용
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
          </div>  -->
        </div>
     
    </div>


    <script type="text/javascript">
        $('#showDiary').hide();


        date_key = 'date';
        date = [];
        // 처음 시작할 때 리스트를 로드하는 함수.
        
        function load() {
            //localStorage의 date를 불러옴
            if(localStorage.getItem(date_key) != null){
                date = JSON.parse(localStorage.getItem(date_key));
            }

            // 이미 있던 리스트들을 한번 없애준다.
            $(".row").text("");

            // 그 자료의 날짜를 한바퀴 돈다.
            for (var i in date) {
                var icon;
                var key = date[i];
                var date_info = JSON.parse(localStorage.getItem(key));
                $("#section").append(
                    
                    "<div data-toggle='modal' data-target='#exampleModalLong' class='date_btn' data-date='" +
                        key +
                        "'>" +

                        key.replace("-", "년").replace("-", "월") +
                        "일" +
                    "</div>"
                );
            }

            // "date-btn"이라는 클래스를 가진 버튼을 누르면
            $(document).on("click", ".date_btn", function(e) {
                // 해당 버튼의 날짜 값을 가져와서


                var text = $(this).attr("data-date");
                // 로컬스토리지에서 해당하는 날짜의 객체(정보)를 가져와서
                var data = JSON.parse(localStorage.getItem(text));

                
                // 만약 해당 날짜의 감정이 good 이면 icon 은 fa-grin 이런식으로...
                var icon
                if (data["diary"]["emotion"] == "good") {
                icon = "fa-grin";
                } else if (data["diary"]["emotion"] == "normal") {
                icon = "fa-flushed";
                } else if (data["diary"]["emotion"] == "bad") {
                icon = "fa-angly";
                }

                // 모달에 있던 내용을 한번 비워주고
                $("#showDiary").text("")
                // 해당 내용으로 채운다.
                $("#showDiary").text(data.diary.content);
                // 감정에 따라 클래스를 바꿔서 텍스트 뒤에 아이콘 추가.
                $("#showDiary").append('<i class="far ' + icon + '"></i>')

                $('#writeDiary').hide();
                $('#showDiary').show();
            })


            // date라는 클래스를 가진 요소를 클릭하면(하면상에서는 날짜를 클릭하면)
            $(".date-box").click(function(e) {
                e.preventDefault();
                // 클릭된 해당 날짜 데이터 값을 읽어와 date 변수에 저장한나.
                var date = $(this).attr("data-date");
                // 해당 날짜의 콘텐츠와 감정을 요소에 담아
                var data =
                "<div class='date-textbox'>" + "<h2>일기 내역 보기</h2>" +
                JSON.parse(localStorage.getItem(date))["diary"][
                    "content"
                ] +
                "</div>";
                // section이라는 id를 가진 박스를 한번 비워주고 데이터를 가진 요소를 추가한다.
                $("#section").text("");
                $("#section").append(data);
            });
        } // load 종료 

        $(document).ready(function(){
            // 시작시 로컬스토리지 로드하는 함수 호출
            load();

            // 폼태그의 기본 submit 이벤트를 막는다.
            $("form").submit(function(e) {
                e.preventDefault();
            });
            // 중복체크를 막는 함수
            $(".check-btn").change(function(e) {
            $(".check-btn")[0].checked = false;
            $(".check-btn")[1].checked = false;
            $(".check-btn")[2].checked = false;
            $(this)[0].checked = true;
            });
        

        // 저장하면 로컬스토리지에 저장하고, 다시 로드한다.
        $("#SaveButton").click(function(e) {
        
            // 작성한 글 내용을 text변수에 저장한다.
            var text = $("#writeDiary").val();

            // 체크된 input의 id가 무엇인지 알아내서 emotion이라는 변수에 저장한다.
            var emotion = $(".check-btn:checked")[0].id;

            // 오늘 날짜를 저장한다.
            var today = new Date().toISOString().slice(2, 10);
            var isExist = false;  
            today = '19-03-26';


            for(var i in date){
                if(date.indexOf(today)>=0) {
                    var date_info = JSON.parse(localStorage.getItem(today));
                    isExist = true;
                    //console.log('이미있다구..');
                }
            }

            if(isExist == false) {
                //없으니까 내가 만들고 저장할 정보를 담는다.
                var date_info = {
                                'food': {},
                                'workout': [],
                                'diary': {'emotion':emotion, 'content':text}
                        };
                
            } else { //있으면 아까 불러왔던 date_info에 내가 저장할 정보를 담는다.
                date_info['diary'] = {
                        "emotion": emotion,
                        "content": text,
                    }
            }

         

            // 로컬스토리지에 저장한다.
            localStorage.setItem(today, JSON.stringify(date_info));

            if(isExist == false){
                console.log('flag 동작안함');
                date.push(today);
                localStorage.setItem('date', JSON.stringify(date));
            }

             load();

            }); // click event end 
        });
        
    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>